<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>المصحف — كتاب قابل للتقليب</title>

<link rel="stylesheet" href="https://unpkg.com/page-flip/dist/css/page-flip.css">
<script src="https://unpkg.com/page-flip/dist/js/page-flip.browser.js"></script>

<style>
  :root{ --container-max-width:1100px; }
  html,body{
    margin:0; padding:0;
    font-family:Tajawal, Tahoma, "Segoe UI", Arial;
    background:#f3f3f3;
    direction:rtl;
  }
  .wrap{ max-width:var(--container-max-width); margin:18px auto; padding:10px; }
  header{text-align:center; margin-bottom:10px;}
  header h1{ margin:0; font-size:1.3rem; }

  .book-container{
    display:flex;
    justify-content:center;
    align-items:flex-start;
    gap:20px;
  }

  #book{
    width:100%;
    max-width:900px;
    height:700px;
    background:#fff;
    border-radius:10px;
    box-shadow:0 6px 18px rgba(0,0,0,0.08);
    overflow:hidden;
    position:relative;
  }

  .toc{
    width:220px;
    max-height:80vh;
    background:#fff;
    border-radius:12px;
    padding:12px;
    overflow:auto;
    position:sticky;
    top:20px;
    box-shadow:0 8px 24px rgba(0,0,0,0.12);
  }
  .toc .item{
    background:#f7f8fb;
    border-radius:8px;
    padding:10px;
    cursor:pointer;
    margin-bottom:10px;
    transition:background .15s, transform .08s;
    text-align:right;
  }
  .toc .item:hover{
    background:#e6f0ff;
    transform:translateX(-4px);
  }

  /* مناطق النقر للّتحكم باتجاه التقليب (اختياري، إن أردت لاحقًا) */
  .flip-zone{ position:absolute; top:0; height:100%; width:50%; z-index:999; background:transparent; }
  .flip-zone.left { right:0; } /* النصف الأيمن في DOM يمثل اليمين بصيغة RTL */
  .flip-zone.right { left:0; }

  @media (max-width:920px){
    .book-container{ flex-direction:column; align-items:center; }
    .toc{ position:relative; width:90%; max-width:420px; margin-bottom:10px; top:auto; }
    #book{ height:560px; }
  }
  @media (max-width:480px){ #book{ height:420px; } }
</style>
</head>

<body>
<div class="wrap">
<header>
  <h1>المصحف الشريف — نسخة التقليب</h1>
</header>

<div class="book-container">
  <div class="toc">
    <h3>الفهرس</h3>
    <div id="tocList"></div>
  </div>

  <div id="book"></div>
</div>
</div>

<script>
(async function(){

  const LAST_PAGE = 685; // عدّل إن اختلف عدد صفحاتك
  const PAGE_TEMPLATE = "pages/{page}.png";
  const BOOKMARKS_JSON = "data/bookmarks.json";

  // تحضير قائمة المسارات (1..LAST_PAGE)
  const pages = [];
  for(let i=1;i<=LAST_PAGE;i++){
    pages.push(PAGE_TEMPLATE.replace("{page}", i));
  }

  // تحميل الفهرس (إن وُجد)
  let bookmarks = [];
  try{
    const resp = await fetch(BOOKMARKS_JSON);
    if(resp.ok) bookmarks = await resp.json();
  }catch(e){ console.warn("error loading bookmarks.json", e); }

  // بناء الفهرس في الشريط الجانبي؛ نمرّر رقم الصفحة الحقيقي (1-based) إلى flipTo
  const toc = document.getElementById("tocList");
  if(Array.isArray(bookmarks) && bookmarks.length){
    bookmarks.forEach(item=>{
      const div = document.createElement("div");
      div.className = "item";
      div.textContent = item.title;
      div.tabIndex = 0;
      div.addEventListener('click', ()=> flipTo(item.page) );
      div.addEventListener('keydown', (e)=>{ if(e.key === 'Enter' || e.key === ' ') { e.preventDefault(); flipTo(item.page); } });
      toc.appendChild(div);
    });
  } else {
    // إن لم يوجد فهرس، أنشئ عناصر افتراضية (الصفحة 1..N)
    for(let p=1;p<=LAST_PAGE;p++){
      const div = document.createElement("div");
      div.className = "item";
      div.textContent = "الصفحة " + p;
      div.tabIndex = 0;
      div.addEventListener('click', ()=> flipTo(p));
      div.addEventListener('keydown', (e)=>{ if(e.key === 'Enter' || e.key === ' ') { e.preventDefault(); flipTo(p); } });
      toc.appendChild(div);
    }
  }

  // خيارات PageFlip
  function getOptions(){
    return {
      width: 900,
      height: 700,
      showCover: true,
      size: "stretch",
      rtl: true,               // مهم: نحتاج rtl=true لعرض عربي
      usePortrait: false,
      mobileScrollSupport: false
      // يمكنك إضافة disableFlipByClick:true إن أردت التحكم اليدوي بالنقر
    };
  }

  const bookEl = document.getElementById("book");
  const FlipCtor = window.PageFlip || (window.St && window.St.PageFlip);
  if(!FlipCtor){
    bookEl.innerHTML = "<div style='padding:20px'>خطأ: مكتبة PageFlip غير متاحة.</div>";
    return;
  }

  // تهيئة الفليب
  const flip = new FlipCtor(bookEl, getOptions());
  flip.loadFromImages(pages);

  // helper: صفحة PDF (1-based) -> index المطلوب لمكتبة PageFlip في وضع rtl
  function pageToIndex(pageNumber){
    // pages array is [1,2,...,LAST_PAGE]
    // في وضع rtl: index 0 يعرض آخر صفحة (page LAST_PAGE)
    // لذا index المطلوب = pages.length - pageNumber
    return pages.length - pageNumber;
  }

  // افتح العرض مبدئياً على "آخر صفحة" ظاهريًا
  // index = 0 في هذا الوضع يعرض الصفحة LAST_PAGE، ولكن لضمان سلوك موثوق نستخدم flip.flip(0)
  try { flip.flip(0); } catch(e){ /* ignore */ }

  // دالة عامة للانتقال لرقم صفحة (1-based)
  window.flipTo = function(pageNumber){
    if(!pageNumber || pageNumber < 1 || pageNumber > pages.length) return;
    const idx = pageToIndex(Number(pageNumber));
    try { flip.flip(idx); } catch(e){ console.error(e); }
  };

  // (اختياري) مناطق نقر شفافة: النصف الأيمن ينتقل للأمام (next)، النصف الأيسر للوراء (prev)
  // هذا يفيد لو أردت تحكّم إضافي في اتجاه التقليب باللمس/نقر.
  (function attachFlipZones(){
    const leftZone = document.createElement('div');
    leftZone.className = 'flip-zone left';
    const rightZone = document.createElement('div');
    rightZone.className = 'flip-zone right';
    bookEl.appendChild(leftZone);
    bookEl.appendChild(rightZone);

    leftZone.addEventListener('click', ()=> {
      // في rtl المقصود: النقر على الطرف الأيمن من الواجهة (leftZone DOM) يتقدّم بالكتاب
      try{ flip.flipNext(); }catch(e){ try{ flip.flip(Math.max(0, flip.getCurrentPageIndex() - 1)); }catch(_){} }
    }, {passive:true});
    rightZone.addEventListener('click', ()=> {
      try{ flip.flipPrev(); }catch(e){ try{ flip.flip(Math.min(pages.length-1, flip.getCurrentPageIndex() + 1)); }catch(_){} }
    }, {passive:true});
  })();

  // ملاحظة: تحميل الصور تدريجي — إن رأيت دوائر تحميل فهذا طبيعي حتى ينتهي التحميل.
})();
</script>

</body>
</html>
