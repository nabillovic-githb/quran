<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>المصحف — كتاب قابل للتقليب</title>

<!-- PageFlip CSS + JS (CDN) -->
<link rel="stylesheet" href="https://unpkg.com/page-flip/dist/css/page-flip.css">
<script src="https://unpkg.com/page-flip/dist/js/page-flip.browser.js"></script>

<style>
  :root{ --container-max-width:1100px; }
  html,body{
    margin:0; padding:0;
    font-family: "Tajawal", Tahoma, "Segoe UI", Arial, sans-serif;
    background:#f3f3f3;
    direction:rtl;
  }
  .wrap{ max-width:var(--container-max-width); margin:18px auto; padding:10px; }
  header{text-align:center; margin-bottom:10px;}
  header h1{ margin:0; font-size:1.3rem; }

  .book-container{
    display:flex;
    justify-content:center;
    align-items:flex-start;
    gap:20px;
  }

  #book{
    width:100%;
    max-width:900px;
    height:700px;
    background:#fff;
    border-radius:10px;
    box-shadow:0 6px 18px rgba(0,0,0,0.08);
    overflow:hidden;
    position:relative;
  }

  .toc{
    width:220px;
    max-height:80vh;
    background:#fff;
    border-radius:12px;
    padding:12px;
    overflow:auto;
    position:sticky;
    top:20px;
    box-shadow:0 8px 24px rgba(0,0,0,0.12);
  }
  .toc h3{ margin-top:0; margin-bottom:8px; font-size:1rem; }
  .toc .item{
    background:#f7f8fb;
    border-radius:8px;
    padding:10px;
    cursor:pointer;
    margin-bottom:10px;
    transition:background .15s, transform .08s;
    text-align:right;
    user-select:none;
  }
  .toc .item:hover,
  .toc .item:focus{
    background:#e6f0ff;
    transform:translateX(-4px);
    outline:none;
  }

  /* مناطق النقر للتحكم بالصفحات (شفافة) */
  .flip-zone{ position:absolute; top:0; height:100%; width:50%; z-index:999; background:transparent; }
  .flip-zone.left { right:0; }  /* DOM اليسار = الطرف الأيمن بصيغة RTL */
  .flip-zone.right { left:0; }

  /* مؤشر تحميل بسيط */
  .loading-overlay{
    position:absolute; inset:0; display:flex; align-items:center; justify-content:center;
    background:linear-gradient(180deg, rgba(255,255,255,0.6), rgba(255,255,255,0.4));
    z-index:2000;
    font-size:1rem;
  }

  @media (max-width:920px){
    .book-container{ flex-direction:column; align-items:center; }
    .toc{ position:relative; width:90%; max-width:420px; margin-bottom:10px; top:auto; }
    #book{ height:560px; }
  }
  @media (max-width:480px){ #book{ height:420px; } }
</style>
</head>

<body>
<div class="wrap">
  <header>
    <h1>المصحف الشريف — نسخة التقليب</h1>
  </header>

  <div class="book-container">
    <div class="toc" aria-label="فهرس الكتاب">
      <h3>الفهرس</h3>
      <div id="tocList"></div>
    </div>

    <div id="book" role="region" aria-label="نافذة عرض الكتاب">
      <!-- سيتم إنشاء محتوى PageFlip هنا -->
      <div class="loading-overlay" id="loading">جارٍ تحميل الصفحات…</div>
    </div>
  </div>
</div>

<script>
(async function(){

  // === إعدادات قابلة للتعديل ===
  const LAST_PAGE = 685;                    // عدّل حسب عدد صفحاتك
  const PAGE_TEMPLATE = "pages/{page}.png"; // مسار صور الصفحات؛ عدّل إن لزم
  const BOOKMARKS_JSON = "data/bookmarks.json"; // (اختياري) مسارات الفهرس

  // === توليد قائمة الصور ===
  const pages = [];
  for(let i=1;i<=LAST_PAGE;i++){
    pages.push(PAGE_TEMPLATE.replace("{page}", i));
  }

  // === بناء الفهرس الجانبي ===
  const toc = document.getElementById("tocList");
  let bookmarks = [];
  try{
    const resp = await fetch(BOOKMARKS_JSON);
    if(resp.ok){
      const j = await resp.json();
      if(Array.isArray(j) && j.length) bookmarks = j;
    }
  }catch(e){
    // لا بأس إن لم يوجد ملف فهرس
  }

  if(Array.isArray(bookmarks) && bookmarks.length){
    bookmarks.forEach(item=>{
      const div = document.createElement("div");
      div.className = "item";
      div.textContent = item.title || ("الصفحة " + (item.page||'?'));
      div.tabIndex = 0;
      div.addEventListener('click', ()=> flipTo(item.page) );
      div.addEventListener('keydown', (e)=>{ if(e.key === 'Enter' || e.key === ' ') { e.preventDefault(); flipTo(item.page); } });
      toc.appendChild(div);
    });
  } else {
    // فهرس افتراضي
    for(let p=1;p<=LAST_PAGE;p++){
      const div = document.createElement("div");
      div.className = "item";
      div.textContent = "الصفحة " + p;
      div.tabIndex = 0;
      div.addEventListener('click', ()=> flipTo(p));
      div.addEventListener('keydown', (e)=>{ if(e.key === 'Enter' || e.key === ' ') { e.preventDefault(); flipTo(p); } });
      toc.appendChild(div);
    }
  }

  // === خيارات PageFlip ===
  function getOptions(){
    return {
      width: 900,
      height: 700,
      showCover: false,   // إذا أردت غلاف خاص قم بتغييره إلى true مع ضبط المؤشر الابتدائي
      size: "stretch",
      rtl: true,          // مهم جداً لعرض عربي / تقليب من اليسار إلى اليمين بصرياً
      usePortrait: false,
      mobileScrollSupport: false
    };
  }

  const bookEl = document.getElementById("book");
  const loadingEl = document.getElementById("loading");
  const FlipCtor = window.PageFlip || (window.St && window.St.PageFlip);

  if(!FlipCtor){
    bookEl.innerHTML = "<div style='padding:20px'>خطأ: مكتبة PageFlip غير متاحة.</div>";
    return;
  }

  // === إنشاء الكتاب ===
  const flip = new FlipCtor(bookEl, getOptions());

  // تحميل الصور (loadFromImages قد يرجع Promise)
  try{
    await flip.loadFromImages(pages);
  }catch(err){
    console.warn("loadFromImages warning/error:", err);
    // لا نوقف التنفيذ — المكتبة قد تكون تعاملت مع الصور داخلياً
  } finally {
    // إزالة مؤشر التحميل
    if(loadingEl && loadingEl.parentNode) loadingEl.parentNode.removeChild(loadingEl);
  }

  // === دوال تحويل الصفحات (1-based) <-> index المكتبة ===
  function pageToIndex(pageNumber){
    // pageNumber: 1..LAST_PAGE
    // في وضع rtl: index 0 يعرض آخر صفحة، لذا نحسب:
    return pages.length - pageNumber;
  }
  function indexToPage(index){
    return pages.length - index;
  }

  // افتح العرض ابتدائياً عند "الصفحة 1" بحيث تظهر على الجهة اليسرى (العلامة X)
  try {
    const initialIndex = pageToIndex(1);
    // تأكد من أن المؤشر صالح
    const clamped = Math.max(0, Math.min(pages.length-1, initialIndex));
    flip.flip(clamped);
  } catch(e){
    console.warn("initial flip error:", e);
  }

  // دالة عامة للانتقال لرقم صفحة (1-based)
  window.flipTo = function(pageNumber){
    if(!pageNumber || pageNumber < 1 || pageNumber > pages.length) return;
    const idx = pageToIndex(Number(pageNumber));
    try { flip.flip(idx); } catch(e){ console.error(e); }
  };

  // إضافة مناطق نقر شفافة للتحكم باللمس/نقر
  (function attachFlipZones(){
    const leftZone = document.createElement('div');
    leftZone.className = 'flip-zone left';
    const rightZone = document.createElement('div');
    rightZone.className = 'flip-zone right';
    bookEl.appendChild(leftZone);
    bookEl.appendChild(rightZone);

    /* ملاحظات حول السلوك في RTL:
       - بصرياً: الصفحة الأولى تظهر على الجهة اليسرى، والتقليب يتم "من اليسار إلى اليمين".
       - خرائط DOM معكوسة قليلاً لذلك نربط الأزرار بحيث يكون النقر على الطرف الأيمن (من العرض) يسحب الكتاب إلى الخلف.
    */
    leftZone.addEventListener('click', ()=> {
      // الطرف الأيمن من DOM (leftZone) => نتقدّم بالكتاب (next visually)
      try{ flip.flipNext(); }catch(e){ try{ flip.flip(Math.max(0, flip.getCurrentPageIndex() - 1)); }catch(_){} }
    }, {passive:true});
    rightZone.addEventListener('click', ()=> {
      // الطرف الأيسر من DOM (rightZone) => نعود بالكتاب (prev visually)
      try{ flip.flipPrev(); }catch(e){ try{ flip.flip(Math.min(pages.length-1, flip.getCurrentPageIndex() + 1)); }catch(_){} }
    }, {passive:true});
  })();

  // اختياري: اضف هنا أي أزرار تحكم إضافية (تكبير/طباعة/حفظ/إظهار صفحة) إن رغبت.

})();
</script>

</body>
</html>
